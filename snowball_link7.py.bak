from flask import Blueprint, request, jsonify, render_template, redirect, url_for, flash, session
from auth import login_required, get_current_user, get_user_rcms, get_rcm_details, get_key_rcm_details, save_operation_evaluation, get_operation_evaluations, log_user_activity, get_db, is_design_evaluation_completed, get_completed_design_evaluation_sessions
from snowball_link5 import get_user_info, is_logged_in
import file_manager

bp_link7 = Blueprint('link7', __name__)

# ìš´ì˜í‰ê°€ ê´€ë ¨ ê¸°ëŠ¥ë“¤

@bp_link7.route('/operation-evaluation')
@login_required
def user_operation_evaluation():
    """ìš´ì˜í‰ê°€ í˜ì´ì§€"""
    user_info = get_user_info()

    # ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ RCM ëª©ë¡ ì¡°íšŒ
    user_rcms = get_user_rcms(user_info['user_id'])

    # ê° RCMì— ëŒ€í•´ ì™„ë£Œëœ ì„¤ê³„í‰ê°€ ì„¸ì…˜ ì¡°íšŒ ë° í•µì‹¬í†µì œ ê°œìˆ˜ í™•ì¸
    for rcm in user_rcms:
        completed_sessions = get_completed_design_evaluation_sessions(rcm['rcm_id'], user_info['user_id'])

        # ê° ì„¤ê³„í‰ê°€ ì„¸ì…˜ì— ëŒ€í•´ ìš´ì˜í‰ê°€ ì§„í–‰ìƒí™© ì¡°íšŒ
        for session in completed_sessions:
            operation_evaluation_session = f"OP_{session['evaluation_session']}"

            # ìš´ì˜í‰ê°€ ì§„í–‰ í†µì œ ìˆ˜ ì¡°íšŒ
            from auth import count_operation_evaluations
            completed_count = count_operation_evaluations(
                rcm['rcm_id'],
                user_info['user_id'],
                operation_evaluation_session,
                session['evaluation_session']
            )
            session['operation_completed_count'] = completed_count

        rcm['completed_design_sessions'] = completed_sessions
        rcm['design_evaluation_completed'] = len(completed_sessions) > 0

        # í•µì‹¬í†µì œ ê°œìˆ˜ ì¡°íšŒ (ëª¨ë“  í•µì‹¬í†µì œ)
        key_controls = get_key_rcm_details(rcm['rcm_id'])
        rcm['key_control_count'] = len(key_controls)
        rcm['has_key_controls'] = len(key_controls) > 0

        # ê° ì™„ë£Œëœ ì„¤ê³„í‰ê°€ ì„¸ì…˜ì— ëŒ€í•´ ìš´ì˜í‰ê°€ ê°€ëŠ¥í•œ í†µì œ ê°œìˆ˜ ì¶”ê°€
        for session in completed_sessions:
            eligible_controls = get_key_rcm_details(rcm['rcm_id'], user_info['user_id'], session['evaluation_session'])
            session['eligible_control_count'] = len(eligible_controls)

    log_user_activity(user_info, 'PAGE_ACCESS', 'ìš´ì˜í‰ê°€', '/user/operation-evaluation',
                     request.remote_addr, request.headers.get('User-Agent'))

    return render_template('user_operation_evaluation.jsp',
                         is_logged_in=is_logged_in(),
                         user_info=user_info,
                         user_rcms=user_rcms,
                         remote_addr=request.remote_addr)

@bp_link7.route('/operation-evaluation/rcm', methods=['GET', 'POST'])
@login_required
def user_operation_evaluation_rcm():
    """RCMë³„ ìš´ì˜í‰ê°€ í˜ì´ì§€ (ì„¤ê³„í‰ê°€ ì„¸ì…˜ ê¸°ë°˜)"""
    user_info = get_user_info()

    # POSTë¡œ ì „ë‹¬ëœ RCM IDì™€ ì„¤ê³„í‰ê°€ ì„¸ì…˜ ì •ë³´ ë°›ê¸°
    if request.method == 'POST':
        rcm_id = request.form.get('rcm_id')
        design_evaluation_session = request.form.get('design_evaluation_session')
        new_operation_session = request.form.get('new_operation_session')  # ì‹ ê·œ ìš´ì˜í‰ê°€ ì„¸ì…˜ëª…


        if not rcm_id:
            flash('RCM ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error')
            return redirect(url_for('link7.user_operation_evaluation'))
        if not design_evaluation_session:
            flash('ì„¤ê³„í‰ê°€ ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error')
            return redirect(url_for('link7.user_operation_evaluation'))

        # ì„¸ì…˜ì— ì €ì¥
        session['current_operation_rcm_id'] = int(rcm_id)
        session['current_design_evaluation_session'] = design_evaluation_session

        # ì‹ ê·œ ìš´ì˜í‰ê°€ ì„¸ì…˜ì¸ ê²½ìš°
        if new_operation_session:
            session['new_operation_session_name'] = new_operation_session
            flash(f'ìƒˆë¡œìš´ ìš´ì˜í‰ê°€ ì„¸ì…˜ "{new_operation_session}"ì„ ì‹œì‘í•©ë‹ˆë‹¤.', 'success')
        else:
            # ê¸°ì¡´ ì„¸ì…˜ ì œê±°
            session.pop('new_operation_session_name', None)

    # POSTë“  GETì´ë“  ì„¸ì…˜ì—ì„œ ì •ìˆ˜í˜• rcm_idë¥¼ ê°€ì ¸ì˜´
    rcm_id = session.get('current_operation_rcm_id')
    design_evaluation_session = session.get('current_design_evaluation_session')

    if not rcm_id:
        flash('RCM ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error')
        return redirect(url_for('link7.user_operation_evaluation'))
    if not design_evaluation_session:
        flash('ì„¤ê³„í‰ê°€ ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error')
        return redirect(url_for('link7.user_operation_evaluation'))

    # ì‚¬ìš©ìê°€ í•´ë‹¹ RCMì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
    user_rcms = get_user_rcms(user_info['user_id'])
    rcm_ids = [rcm['rcm_id'] for rcm in user_rcms]

    if rcm_id not in rcm_ids:
        flash('í•´ë‹¹ RCMì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error')
        return redirect(url_for('link7.user_operation_evaluation'))


    # í•´ë‹¹ ì„¤ê³„í‰ê°€ ì„¸ì…˜ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
    completed_sessions = get_completed_design_evaluation_sessions(rcm_id, user_info['user_id'])

    session_found = False
    for session_item in completed_sessions:
        if session_item['evaluation_session'] == design_evaluation_session:
            session_found = True
            break

    if not session_found:
        flash(f'ì„¤ê³„í‰ê°€ ì„¸ì…˜ "{design_evaluation_session}"ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ìš´ì˜í‰ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning')
        return redirect(url_for('link7.user_operation_evaluation'))
    
    # RCM ì •ë³´ ì¡°íšŒ
    rcm_info = None
    for rcm in user_rcms:
        if rcm['rcm_id'] == rcm_id:
            rcm_info = rcm
            break
    
    # RCM í•µì‹¬í†µì œ ë°ì´í„° ì¡°íšŒ (ìš´ì˜í‰ê°€ëŠ” í•µì‹¬í†µì œì´ë©´ì„œ ì„¤ê³„í‰ê°€ê°€ 'ì ì •'ì¸ í†µì œë§Œ ëŒ€ìƒ)
    rcm_details = get_key_rcm_details(rcm_id, user_info['user_id'], design_evaluation_session)

    # í•µì‹¬í†µì œì´ë©´ì„œ ì„¤ê³„í‰ê°€ê°€ 'ì ì •'ì¸ í†µì œê°€ ì—†ëŠ” ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    if not rcm_details:
        flash('í•´ë‹¹ RCMì— ì„¤ê³„í‰ê°€ ê²°ê³¼ê°€ "ì ì •"ì¸ í•µì‹¬í†µì œê°€ ì—†ì–´ ìš´ì˜í‰ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning')
        return redirect(url_for('link7.user_operation_evaluation'))

    # ìš´ì˜í‰ê°€ ì„¸ì…˜ëª… ìƒì„± (ì„¤ê³„í‰ê°€ ì„¸ì…˜ ê¸°ë°˜)
    operation_evaluation_session = f"OP_{design_evaluation_session}"

    # ìš´ì˜í‰ê°€ Header/Line ë°ì´í„° ë™ê¸°í™” (ì„¤ê³„í‰ê°€ ê²°ê³¼ ë³€ê²½ ë°˜ì˜)
    sync_messages = []
    try:
        # ê¸°ì¡´ ìš´ì˜í‰ê°€ í—¤ë” í™•ì¸
        from auth import get_or_create_operation_evaluation_header
        with get_db() as conn:
            header_id = get_or_create_operation_evaluation_header(conn, rcm_id, user_info['user_id'], operation_evaluation_session, design_evaluation_session)

            # í˜„ì¬ ëŒ€ìƒ í†µì œ ì½”ë“œ ëª©ë¡ (í•µì‹¬í†µì œ + ì„¤ê³„í‰ê°€ 'ì ì •')
            current_control_codes = {detail['control_code'] for detail in rcm_details}

            # ê¸°ì¡´ Line ë°ì´í„° ì¡°íšŒ
            existing_lines = conn.execute('''
                SELECT line_id, control_code
                FROM sb_operation_evaluation_line
                WHERE header_id = ?
            ''', (header_id,)).fetchall()

            existing_control_codes = {line['control_code'] for line in existing_lines}

            # ì‹ ê·œ ì¶”ê°€ëœ í†µì œ (ì„¤ê³„í‰ê°€ ë¶€ì ì •â†’ì ì • ë³€ê²½)
            new_controls = current_control_codes - existing_control_codes
            if new_controls:
                for idx, detail in enumerate(rcm_details):
                    if detail['control_code'] in new_controls:
                        conn.execute('''
                            INSERT INTO sb_operation_evaluation_line (
                                header_id, control_code, control_sequence
                            ) VALUES (?, ?, ?)
                        ''', (header_id, detail['control_code'], idx + 1))
                sync_messages.append(f"ğŸ“Œ ì‹ ê·œ ì¶”ê°€: {len(new_controls)}ê°œ (ì„¤ê³„í‰ê°€ ë¶€ì ì •â†’ì ì •)")

            conn.commit()

            # ë™ê¸°í™” ë©”ì‹œì§€ í‘œì‹œ
            if sync_messages:
                flash(' '.join(sync_messages), 'success')
    except Exception as e:
        flash(f"ìš´ì˜í‰ê°€ ë°ì´í„° ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}", 'error')

    # ê¸°ì¡´ ìš´ì˜í‰ê°€ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° (Header-Line êµ¬ì¡°)
    try:
        evaluations = get_operation_evaluations(rcm_id, user_info['user_id'], operation_evaluation_session, design_evaluation_session)
        evaluation_dict = {}
        for eval_data in evaluations:
            control_code = eval_data['control_code']
            evaluation_dict[control_code] = {
                'operating_effectiveness': eval_data['operating_effectiveness'],
                'sample_size': eval_data['sample_size'],
                'exception_count': eval_data['exception_count'],
                'exception_details': eval_data['exception_details'],
                'conclusion': eval_data['conclusion'],
                'improvement_plan': eval_data['improvement_plan']
            }
    except Exception as e:
        evaluation_dict = {}

    log_user_activity(user_info, 'PAGE_ACCESS', 'RCM ìš´ì˜í‰ê°€', '/operation-evaluation/rcm',
                     request.remote_addr, request.headers.get('User-Agent'))

    return render_template('user_operation_evaluation_rcm.jsp',
                         rcm_id=rcm_id,
                         design_evaluation_session=design_evaluation_session,
                         operation_evaluation_session=operation_evaluation_session,
                         rcm_info=rcm_info,
                         rcm_details=rcm_details,
                         evaluation_dict=evaluation_dict,
                         is_logged_in=is_logged_in(),
                         user_info=user_info,
                         remote_addr=request.remote_addr)

@bp_link7.route('/api/operation-evaluation/save', methods=['POST'])
@login_required
def save_operation_evaluation_api():
    """ìš´ì˜í‰ê°€ ê²°ê³¼ ì €ì¥ API"""
    user_info = get_user_info()
    data = request.get_json()
    
    rcm_id = data.get('rcm_id')
    design_evaluation_session = data.get('design_evaluation_session')
    control_code = data.get('control_code')
    evaluation_data = data.get('evaluation_data')

    if not all([rcm_id, design_evaluation_session, control_code, evaluation_data]):
        return jsonify({
            'success': False,
            'message': 'í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        })

    # ìš´ì˜í‰ê°€ ì„¸ì…˜ëª… ìƒì„±
    operation_evaluation_session = f"OP_{design_evaluation_session}"
    
    try:
        # ì‚¬ìš©ìê°€ í•´ë‹¹ RCMì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
        with get_db() as conn:
            access_check = conn.execute('''
                SELECT permission_type FROM sb_user_rcm
                WHERE user_id = ? AND rcm_id = ? AND is_active = 'Y'
            ''', (user_info['user_id'], rcm_id)).fetchone()

            if not access_check:
                return jsonify({
                    'success': False,
                    'message': 'í•´ë‹¹ RCMì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
                })

        # í•´ë‹¹ ì„¤ê³„í‰ê°€ ì„¸ì…˜ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
        completed_sessions = get_completed_design_evaluation_sessions(rcm_id, user_info['user_id'])
        session_found = False
        for session in completed_sessions:
            if session['evaluation_session'] == design_evaluation_session:
                session_found = True
                break

        if not session_found:
            return jsonify({
                'success': False,
                'message': f'ì„¤ê³„í‰ê°€ ì„¸ì…˜ "{design_evaluation_session}"ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ìš´ì˜í‰ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            })

        # ìš´ì˜í‰ê°€ ê²°ê³¼ ì €ì¥ (Header-Line êµ¬ì¡°)
        save_operation_evaluation(rcm_id, control_code, user_info['user_id'], operation_evaluation_session, design_evaluation_session, evaluation_data)
        
        # í™œë™ ë¡œê·¸ ê¸°ë¡
        log_user_activity(user_info, 'OPERATION_EVALUATION', f'ìš´ì˜í‰ê°€ ì €ì¥ - {control_code}', 
                         f'/api/operation-evaluation/save', 
                         request.remote_addr, request.headers.get('User-Agent'))
        
        return jsonify({
            'success': True,
            'message': 'ìš´ì˜í‰ê°€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        })

@bp_link7.route('/api/operation-evaluation/load/<int:rcm_id>/<design_evaluation_session>')
@login_required
def load_operation_evaluation(rcm_id, design_evaluation_session):
    """ìš´ì˜í‰ê°€ ë°ì´í„° ë¡œë“œ API (ì„¤ê³„í‰ê°€ ì„¸ì…˜ë³„)"""
    user_info = get_user_info()

    try:
        # ê¶Œí•œ ì²´í¬
        user_rcms = get_user_rcms(user_info['user_id'])
        rcm_ids = [rcm['rcm_id'] for rcm in user_rcms]

        if rcm_id not in rcm_ids:
            return jsonify({'success': False, 'message': 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'}), 403

        # ìš´ì˜í‰ê°€ ì„¸ì…˜ëª… ìƒì„±
        operation_evaluation_session = f"OP_{design_evaluation_session}"

        evaluations = get_operation_evaluations(rcm_id, user_info['user_id'], operation_evaluation_session, design_evaluation_session)

        evaluation_dict = {}
        for eval_data in evaluations:
            control_code = eval_data['control_code']
            evaluation_dict[control_code] = {
                'operating_effectiveness': eval_data['operating_effectiveness'],
                'sample_size': eval_data['sample_size'],
                'exception_count': eval_data['exception_count'],
                'exception_details': eval_data['exception_details'],
                'conclusion': eval_data['conclusion'],
                'improvement_plan': eval_data['improvement_plan']
            }

        return jsonify({'success': True, 'evaluations': evaluation_dict})

    except Exception as e:
        return jsonify({'success': False, 'message': 'ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}), 500

@bp_link7.route('/api/operation-evaluation/reset', methods=['POST'])
@login_required
def reset_operation_evaluations_api():
    """ìš´ì˜í‰ê°€ ê²°ê³¼ ì´ˆê¸°í™” API"""
    user_info = get_user_info()
    data = request.get_json()
    
    rcm_id = data.get('rcm_id')
    design_evaluation_session = data.get('design_evaluation_session')

    if not all([rcm_id, design_evaluation_session]):
        return jsonify({
            'success': False,
            'message': 'RCM ID ë˜ëŠ” ì„¤ê³„í‰ê°€ ì„¸ì…˜ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        })

    # ìš´ì˜í‰ê°€ ì„¸ì…˜ëª… ìƒì„±
    operation_evaluation_session = f"OP_{design_evaluation_session}"
    
    try:
        # ì‚¬ìš©ìê°€ í•´ë‹¹ RCMì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
        with get_db() as conn:
            access_check = conn.execute('''
                SELECT permission_type FROM sb_user_rcm
                WHERE user_id = ? AND rcm_id = ? AND is_active = 'Y'
            ''', (user_info['user_id'], rcm_id)).fetchone()
            
            if not access_check:
                return jsonify({
                    'success': False,
                    'message': 'í•´ë‹¹ RCMì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
                })
            
            # í•´ë‹¹ ì‚¬ìš©ìì˜ í•´ë‹¹ ì„¸ì…˜ ìš´ì˜í‰ê°€ ê²°ê³¼ ì‚­ì œ (Header-Line êµ¬ì¡°)
            # 1. ë¨¼ì € line ë ˆì½”ë“œë“¤ ì‚­ì œ
            conn.execute('''
                DELETE FROM sb_operation_evaluation_line
                WHERE header_id IN (
                    SELECT header_id FROM sb_operation_evaluation_header
                    WHERE rcm_id = ? AND user_id = ? AND evaluation_session = ? AND design_evaluation_session = ?
                )
            ''', (rcm_id, user_info['user_id'], operation_evaluation_session, design_evaluation_session))

            # 2. header ë ˆì½”ë“œ ì‚­ì œ
            cursor = conn.execute('''
                DELETE FROM sb_operation_evaluation_header
                WHERE rcm_id = ? AND user_id = ? AND evaluation_session = ? AND design_evaluation_session = ?
            ''', (rcm_id, user_info['user_id'], operation_evaluation_session, design_evaluation_session))
            deleted_count = cursor.rowcount
            
            conn.commit()
        
        # í™œë™ ë¡œê·¸ ê¸°ë¡
        log_user_activity(user_info, 'OPERATION_EVALUATION_RESET', f'ìš´ì˜í‰ê°€ ì´ˆê¸°í™” - RCM ID: {rcm_id}, ì„¤ê³„í‰ê°€ ì„¸ì…˜: {design_evaluation_session}',
                         f'/api/operation-evaluation/reset',
                         request.remote_addr, request.headers.get('User-Agent'))
        
        return jsonify({
            'success': True,
            'message': f'{deleted_count}ê°œì˜ ìš´ì˜í‰ê°€ ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
            'deleted_count': deleted_count
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': 'ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        })