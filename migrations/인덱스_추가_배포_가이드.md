# 외래키 인덱스 추가 배포 가이드

## 개요

N+1 쿼리 문제 해결 및 조인 성능 향상을 위해 외래키 컬럼에 인덱스를 추가하는 마이그레이션입니다.

- **마이그레이션 파일**: `migrations/add_foreign_key_indexes.py`
- **호환성**: SQLite, MySQL
- **영향 범위**: 20개 인덱스 추가 (외래키 컬럼)
- **예상 소요 시간**: 1-2분 (데이터 규모에 따라 다름)

## 추가되는 인덱스 목록

### 핵심 인덱스 (성능 향상 효과 큼)

1. **sb_evaluation_header**
   - `idx_evaluation_header_rcm_id` - RCM별 평가 조회 최적화

2. **sb_evaluation_line**
   - `idx_evaluation_line_header_id` - 평가 상세 조회 최적화

3. **sb_evaluation_sample**
   - `idx_evaluation_sample_line_id` - 샘플 데이터 조회 최적화

4. **sb_evaluation_image**
   - `idx_evaluation_image_line_id` - 이미지 조회 최적화

5. **sb_rcm_detail**
   - `idx_rcm_detail_rcm_id` - RCM 상세 조회 최적화

6. **sb_user_rcm**
   - `idx_user_rcm_user_id` - 사용자별 RCM 목록 조회 최적화
   - `idx_user_rcm_rcm_id` - RCM별 권한 사용자 조회 최적화

### 기타 인덱스

7. `idx_user_activity_log_user_id` - 사용자 활동 로그
8. `idx_rcm_user_id` - RCM 업로드 사용자
9. `idx_rcm_detail_mapped_std_control_id` - 기준통제 매핑
10. `idx_rcm_detail_mapped_by` - 매핑 작업자
11. `idx_rcm_detail_ai_reviewed_by` - AI 검토자
12. `idx_user_rcm_granted_by` - 권한 부여자
13. `idx_internal_assessment_rcm_id` - 내부평가 RCM
14. `idx_internal_assessment_user_id` - 내부평가 사용자
15. `idx_rcm_standard_mapping_rcm_id` - RCM-기준통제 매핑
16. `idx_rcm_standard_mapping_std_control_id` - 기준통제 매핑
17. `idx_rcm_standard_mapping_mapped_by` - 매핑 작업자
18. `idx_rcm_completeness_eval_rcm_id` - 완성도 평가 RCM
19. `idx_rcm_completeness_eval_eval_by` - 완성도 평가자
20. `idx_evaluation_image_line_id` - 평가 이미지

## 로컬 환경 배포 (SQLite)

### 1. 백업 생성
```bash
cd c:\Pythons\snowball
copy snowball.db snowball.db.backup_before_indexes
```

### 2. 마이그레이션 실행
```bash
python migrations/add_foreign_key_indexes.py
```

### 3. 결과 확인
- 성공 시: "생성: 20개" 메시지 표시
- 레거시 테이블(설계/운영평가 분리 테이블)은 자동으로 건너뜀

### 4. 롤백 (문제 발생 시)
```bash
# 인덱스 제거
python migrations/add_foreign_key_indexes.py --rollback

# 또는 백업 복원
copy snowball.db.backup_before_indexes snowball.db
```

## 운영 환경 배포 (MySQL - PythonAnywhere)

### 사전 준비

1. **백업 확인**
   - PythonAnywhere의 자동 백업이 활성화되어 있는지 확인
   - 또는 수동으로 MySQL 백업 생성

2. **점검 시간 선택**
   - 사용자가 적은 시간대 선택 (예: 새벽 시간)
   - 예상 소요 시간: 1-2분

### 배포 절차

#### 1단계: 환경 변수 확인
```bash
# PythonAnywhere Bash Console에서
cd ~/snowball
cat .env | grep USE_MYSQL
# USE_MYSQL=true 확인
```

#### 2단계: 마이그레이션 실행
```bash
cd ~/snowball
python3 migrations/add_foreign_key_indexes.py
```

#### 3단계: 결과 확인
```
[완료] 인덱스 추가 완료
  - 생성: 20개
  - 건너뜀: 6개 (레거시 테이블)
  - 오류: 0개
```

#### 4단계: 애플리케이션 테스트
1. 웹 앱 재시작 (PythonAnywhere Web 탭)
2. 주요 기능 테스트:
   - RCM 목록 조회
   - 설계평가 상세 보기
   - 운영평가 상세 보기
   - Excel 내보내기

#### 5단계: 성능 확인
- 페이지 로딩 속도 체감 확인
- 특히 평가 상세 페이지가 빨라졌는지 확인

### 롤백 절차 (문제 발생 시)

#### 방법 1: 마이그레이션 롤백
```bash
cd ~/snowball
python3 migrations/add_foreign_key_indexes.py --rollback
# "yes" 입력하여 확인
```

#### 방법 2: MySQL 백업 복원
```bash
# PythonAnywhere의 MySQL 백업에서 복원
# (PythonAnywhere 대시보드에서 수동 복원 필요)
```

## 검증 방법

### SQLite 인덱스 확인
```bash
sqlite3 snowball.db ".indexes sb_evaluation_header"
# 출력 예상: idx_evaluation_header_rcm_id, idx_eval_header_rcm_session
```

### MySQL 인덱스 확인
```sql
-- MySQL Console에서
SHOW INDEX FROM sb_evaluation_header;
SHOW INDEX FROM sb_evaluation_line;
SHOW INDEX FROM sb_evaluation_sample;
```

### 성능 테스트
```python
# Python 콘솔에서
from db_config import get_db
import time

with get_db() as conn:
    start = time.time()
    # RCM 목록 조회 (인덱스 사용)
    result = conn.execute("""
        SELECT r.*, eh.status, eh.progress
        FROM sb_rcm r
        LEFT JOIN sb_evaluation_header eh ON r.rcm_id = eh.rcm_id
    """).fetchall()
    print(f"소요 시간: {time.time() - start:.3f}초")
    print(f"결과: {len(result)}개")
```

## 주의사항

1. **중복 실행 안전**
   - `CREATE INDEX IF NOT EXISTS` 사용으로 중복 실행 시에도 안전
   - 이미 인덱스가 있으면 자동으로 건너뜀

2. **레거시 테이블**
   - `sb_design_evaluation_header/line` - 통합 전 설계평가 테이블
   - `sb_operation_evaluation_header/line` - 통합 전 운영평가 테이블
   - 테이블이 없으면 자동으로 건너뛰므로 안전

3. **다운타임**
   - 인덱스 생성 중에도 애플리케이션은 정상 작동
   - 단, 해당 테이블에 대한 쿼리가 약간 느려질 수 있음
   - 소규모 데이터베이스이므로 영향 최소

4. **데이터베이스 호환성**
   - SQLite와 MySQL 모두에서 테스트 완료
   - 표준 SQL 사용으로 호환성 보장

## 기대 효과

### N+1 쿼리 해결
- **기존**: RCM 100개 조회 시 101번의 쿼리 실행
- **개선 후**: 2번의 쿼리로 단축 (98% 감소)

### 성능 향상
1. **RCM 목록 조회**: 평가 상태 조인 성능 향상
2. **설계평가 상세**: 샘플 데이터 조회 성능 향상
3. **Excel 내보내기**: 이미지 조회 성능 향상

### 구체적 개선 사항
- [auth.py:645-687] RCM 목록 + 평가 상태 조회
- [auth.py:1426-1472] 설계평가 + 샘플 데이터 조회
- [snowball_link6.py:1214-1264] Excel 내보내기 + 이미지 조회

## 트러블슈팅

### 오류: "no such column"
- **원인**: 컬럼이 존재하지 않음
- **해결**: 해당 인덱스는 자동으로 건너뜀 (정상 동작)

### 오류: "table already exists"
- **원인**: 인덱스가 이미 존재
- **해결**: `IF NOT EXISTS` 사용으로 자동 건너뜀 (정상 동작)

### 성능 향상이 체감되지 않음
- **원인**: 데이터가 적어서 차이가 미미
- **확인**: 데이터가 많아질수록 효과가 커짐

## 문의

문제 발생 시:
1. 마이그레이션 로그 확인
2. 필요시 롤백 수행
3. 백업에서 복원
